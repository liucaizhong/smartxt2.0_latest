"use strict";function _renderDatalist(e){var t=$("#allConcepts");e.forEach(function(e){var a=document.createElement("OPTION");$(a).val(e),t.append(a)})}function _loadingChart(e){e.showLoading(),$("html, body").animate({scrollTop:$("#charts").offset().top-100},800)}function _renderCharts(e,t){if(1!=method){var a="sn"+source[0],o=$("#"+a);o.hasClass("active")||($("#sourceNavs").find('a.nav-link[class*="active"]').removeClass("active"),o.addClass("active")),$("#sourceNavs").show()}else $("#sourceNavs").hide();$(".theme-inputbar").show(),e||(e=_genUrl(HEATURL)),t||(t=_genUrl(STOCKURL,!0)),_loadingChart(lineChart),$.ajax({url:e,type:"GET",async:!0,dataType:"json",success:function(e){var t=JSON.parse(e);t=JSON.parse(t),t&&t.length&&_renderLineChart(t)},error:function(e){console.log(e)}}),$.ajax({url:t,type:"GET",async:!0,dataType:"json",success:function(e){var t=JSON.parse(e);t=JSON.parse(t),t&&t.length&&_renderHistogram(t)},error:function(e){console.log(e)}})}function _genUrl(e,t){var e=e,a="concepts=",o="sources=",s="date=",n="period=";return e+="userId="+loginfo.username,theme.forEach(function(e){a+=e.trim()+";"}),a=a.substr(0,a.length-1),source.forEach(function(e){o+=e+";"}),o=o.substr(0,o.length-1),e+="&"+a+"&"+o,t&&(s+=$("#date-input").val().replace(/\//g,""),n+=periodRange[period],e+="&"+s+"&"+n),e}function onTriggerSlide(e){var t=$(e),a=t.find("i.fa-angle-double-down")[0],o=t.find("i.fa-angle-double-up")[0];a&&$(a).removeClass("fa-angle-double-down").addClass("fa-angle-double-up"),o&&$(o).removeClass("fa-angle-double-up").addClass("fa-angle-double-down"),$(".theme-conditions .container").slideToggle(1e3)}function onMethod(e){var t=$(e),a=t.attr("id")[1];if(method!=a){method=a,_setDefault();var o=t.siblings('button[class*="btn-valid"]');Array.prototype.forEach.call(o,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")}),t.removeClass("btn-invalid").addClass("btn-valid")}console.log("method:",method)}function _setDefault(){jump&&(jump=!jump,method=0);var e=$("div#btnSource").find('button[class*="btn-valid"]');Array.prototype.forEach.call(e,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")}),source=[],$("button#s0").addClass("btn-valid").removeClass("btn-invalid"),source[0]="0",console.log("source:",source),2==method?$("#theme-input").attr("placeholder","支持主题交叉搜索(半角分号隔开),例如“钢铁;煤炭”"):$("#theme-input").attr("placeholder","输入关键字用于描述要查询的主题信息,例如 “钢铁”");$("div#theme-tags").empty();theme=[],console.log("theme",theme)}function onPeriod(e){var t=$(e),a=t.attr("id")[1];if(period!=a){period=a;var o=t.siblings('button[class*="btn-valid"]');Array.prototype.forEach.call(o,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")}),t.removeClass("btn-invalid").addClass("btn-valid")}console.log("period:",period)}function onSource(e){if(0==method){var t=$(e),a=t.attr("id")[1];if(source[0]!=a){source[0]=a;var o=t.siblings('button[class*="btn-valid"]');Array.prototype.forEach.call(o,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")}),t.removeClass("btn-invalid").addClass("btn-valid")}}else{var t=$(e),a=t.attr("id")[1],s=source.indexOf(a);-1==s?(source.push(a),t.removeClass("btn-invalid").addClass("btn-valid")):(source.splice(s,1),t.removeClass("btn-valid").addClass("btn-invalid"))}console.log("source:",source)}function _showErr(e){$("div#error-msg>strong").text(e),$("div#error-msg").show(500)}function _hideErr(){$("div#error-msg").hide(500)}function addTheme(e){var t=$("input#theme-input"),a=t.val();if(0!=method&&theme.length>=1)return t.val(""),void _showErr("只能输入1个关键字");if(a){t.val("");var o=$('<div class="theme-tag alert alert-success col-xs-3 col-lg-2"></div>')[0],s=$(o),n=$('<span class="theme-txt"></span>')[0];$(n).text(a),s.append(n);var r=$('<button type="button" class="close" aria-label="Close" onclick="delThemeTag(this)"><span aria-hidden="true">&times;</span></button>')[0];s.append(r),$("#theme-tags").append(o),theme.push(a)}console.log("theme",theme)}function delThemeTag(e){var t=$(e),a=t.parent(),o=t.siblings("span")[0],s=theme.indexOf($(o).text());theme.splice(s,1),$(a).remove(),theme.length||_hideErr(),console.log("theme",theme)}function delAlert(e){var t=$(e);t.parent().hide(500)}function _renderLineChart(e){lineChart=echarts.init(document.getElementById("line-chart"));var t=e[0].flag;if(t==-1)return lineChart.hideLoading(),$("#fresh-word").val(""),$("#btnFresh").attr("disabled",!0),!1;if(0==t){var a=$(".btn-theme-collect>i.btn-star");a.hasClass("collect")&&a.removeClass("collect"),$("#fresh-word").val(theme[0]),$("#btnFresh").attr("disabled",!1)}else if(1==t){var a=$(".btn-theme-collect>i.btn-star");a.hasClass("collect")||a.addClass("collect"),$("#fresh-word").val(theme[0]),$("#btnFresh").attr("disabled",!1)}var o=e.splice(1),s=[],n=[],r=[];Array.isArray(o)&&o.forEach(function(e){var t={name:e.concept+" H",type:"line",yAxisIndex:0,itemStyle:{normal:{areaStyle:{type:"default",color:"rgba(239,243,246,.6)"},color:"rgb(50,70,90)"}},symbol:"none"},a={name:e.concept+" I",type:"line",yAxisIndex:1,itemStyle:{normal:{areaStyle:{type:"default",color:"rgba(250,225,222,.6)"},color:"rgb(235,85,30)"}},symbol:"none"},o=[],i=[];1==method?(s.push({name:sourceName[+e.source]+" H",icon:"line"}),s.push({name:sourceName[+e.source]+" I",icon:"line"}),t.name=sourceName[+e.source]+" H",a.name=sourceName[+e.source]+" I"):(s.push({name:e.concept+" H",icon:"line"}),s.push({name:e.concept+" I",icon:"line"})),e.heat.forEach(function(e){o.push(e.heat),i.push(e.index),n.push(e.date)}),t.data=o,r.push(t),a.data=i,r.push(a)});var i="";i=1!=method?sourceName[source[0]]:theme[0],lineChart.setOption({baseOption:{title:{},tooltip:{trigger:"axis"},dataZoom:[{handleColor:"rgb(75,188,208)",fillerColor:"rgb(75,188,208)",borderWidth:0,show:!0,realtime:!0,start:75.5,end:100,height:15}],legend:{data:s},toolbox:{feature:{saveAsImage:{}}},xAxis:{type:"category",data:n,axisLine:{show:!0,lineStyle:{type:"solid",width:1,color:"rgb(75,188,208)"}},axisTick:!1,axisLabel:{textStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},boundaryGap:!1},yAxis:[{name:"关注度(H)",type:"value",splitNumber:10,scale:!0,axisLine:{show:!0,lineStyle:{type:"solid",width:1,color:"rgb(75,188,208)"}},axisLabel:{textStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},splitLine:{show:!0,lineStyle:{type:"dashed",width:1}},nameTextStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},{name:"指数(I)",type:"value",splitNumber:10,scale:!0,axisLine:{show:!0,lineStyle:{type:"solid",width:1,color:"rgb(75,188,208)"}},axisLabel:{textStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},splitLine:{show:!1,lineStyle:{type:"dashed",width:1}},nameTextStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}}],series:r}}),lineChart.hideLoading()}function _renderHistogram(e){var t=e[0].flag;if(t==-1)return!1;var a=e.splice(1),o=[],s=[],n=$($("#tab-list")[0]),r=$($("#tab-content")[0]);n.empty(),r.empty(),histogram=[],Array.isArray(a)&&a.forEach(function(e){1==method?o.push(sourceName[+e.source]):o.push(e.concept);var t=[],a=[],n=[],r=[],i=[],l=[],d=[];if(e.stocks&&e.stocks.length){var c=e.stocks;c.forEach(function(e){t.push(e.name+"("+e.code+")"),a.push(e.txtCor),n.push(e.priceCor),r.push(e.MV),i.push(e.HOLD),l.push(e.CP),d.push(e.RT)}),s.push({category:t,data:[a,n,r,i,l,d]})}else s.push({})});for(var i=0,l=o.length;i<l;++i){var d="c"+i,c=$('<li class="nav-item"></li>'),h=$('<a class="nav-link" data-toggle="tab"role="tab"></a>');$(h).attr("href","#"+d).text(o[i]),i||$(h).addClass("active"),$(c).append(h),n.append(c);var u=$('<div class="tab-pane" role="tabpanel"></div>');$(u).attr("id",d),i||$(u).addClass("active"),r.append(u);var p=jQuery.isEmptyObject(s[i]);if(p)$("#tab-content").text("不存在股票相关指数！").css({"padding-top":"100px","padding-bottom":"100px","text-align":"center"});else for(var m=chartIndex.length,f=0;f<m;++f)f%2?(_renderRightHistogram(s[i].category,s[i].data[f],chartIndex[f],chartColor[f%2],d),echarts.connect([histogram[f-1+m*i],histogram[f+m*i]]),console.log(f-1+m*i,f+m*i)):_renderLeftHistogram(s[i].category,s[i].data[f],chartIndex[f],chartColor[f%2],d)}}function _renderLeftHistogram(e,t,a,o,s){if(t){var n=$('<div class="rel-chart-l"></div>'),r=$("#"+s);leftWidth||(leftWidth=$(r).width()*leftRatio/100),$(n).css("width",leftWidth+"px"),$(r).append(n);var i=echarts.init(n[0]);histogram.push(i),i.setOption({tooltip:{trigger:"axis",axisPointer:{type:"shadow"},position:function(e,t,a){return $(a).width("200"),[e[0],e[1]+18]}},grid:{containLabel:!0},color:[o],legend:{data:[a],x:"right",textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},xAxis:{type:"value",position:"top",axisLine:{show:!1},splitNumber:10,splitLine:{show:!0,lineStyle:{type:"dashed",width:1}},axisLabel:{textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},axisTick:!1},yAxis:{type:"category",data:e,position:"left",inverse:!0,axisTick:!1,axisLine:{show:!1},splitLine:{show:!1}},series:[{name:a,type:"bar",label:{normal:{show:!1,position:"insideRight"}},data:t}]})}}function _renderRightHistogram(e,t,a,o,s){if(t){var n=$('<div class="rel-chart-r"></div>'),r=$("#"+s);rightWidth||(rightWidth=$(r).width()*rightRatio/100),$(n).css("width",rightWidth+"px"),$(r).append(n);var i=echarts.init(n[0]);histogram.push(i),i.setOption({tooltip:{trigger:"axis",axisPointer:{type:"shadow"},position:function(e,t,a){return $(a).width("200"),[e[0],e[1]+18]}},grid:{containLabel:!0},legend:{data:[a],x:"left",textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},xAxis:{type:"value",position:"top",axisLine:{show:!1},splitNumber:10,splitLine:{show:!0,lineStyle:{type:"dashed",width:1}},axisLabel:{textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},axisTick:!1},yAxis:{type:"category",data:e,position:"left",inverse:!0,axisLabel:{show:!1,inside:!0},axisTick:!1,axisLine:{show:!1},splitLine:{show:!1}},color:[o],series:[{name:a,type:"bar",label:{normal:{show:!1,position:"insideRight"}},data:t}]})}}function onEnterTheme(e){e.stopPropagation(),13==e.keyCode&&$("#theme-input").val()&&(e.preventDefault(),addTheme())}function onStar(e){var t=$(e);if(t.hasClass("collect")){var a=URL_UNCOLLECT,o="取消收藏",s="";s+=theme.join(";")+"@",s+=source.join(";");var n={userId:loginfo.username,links:s}}else var a=URL_COLLECT,o="已收藏",n={userId:loginfo.username,concept:theme.join(";"),source:source.join(";")};$.ajax({url:a,method:"POST",data:n,dataType:"json",success:function(e){var a=JSON.parse(e);a=JSON.parse(a),a.flag||a[0].status?(t.toggleClass("collect"),_showFadeMsg(o)):_showFadeMsg(a.msg)},error:function(e){console.log(e)}})}function onsourceNav(e){var t=$(e);$("#sourceNavs").find('a.nav-link[class*="active"]').removeClass("active"),t.addClass("active");var a=t.attr("id");source[0]=a.substr(a.length-1,1),_renderCharts()}function _showFadeMsg(e){var t=$(".theme-inputbar").offset().left-50,a=$(".theme-inputbar").offset().top+50;$("#fade-msg").text(e),$("#fade-alert").css({left:t,top:a}).fadeIn(function(){setTimeout(function(){$("#fade-alert").fadeOut()},1e3)})}function onAddFreshWord(e){var t=$("#fresh-word"),a=t.val();$.ajax({url:URL_ADDFRESHWORD,method:"POST",data:{userId:loginfo.username,concept:a},dataType:"json",success:function(e){var a=JSON.parse(e);a=JSON.parse(a),a.flag?(_showFadeMsg("新词提交成功"),t.val("")):_showFadeMsg(a.msg)},error:function(e){console.log(e)}})}function _setCondition(e,t){if(e&&0!=e.length&&e.forEach(function(e){var t=$('<div class="theme-tag alert alert-success col-xs-3 col-lg-2"></div>')[0],a=$(t),o=$('<span class="theme-txt"></span>')[0];$(o).text(e),a.append(o);var s=$('<button type="button" class="close" aria-label="Close" onclick="delThemeTag(this)"><span aria-hidden="true">&times;</span></button>')[0];a.append(s),$("#theme-tags").append(t)}),t&&0!=t.length){var a=$("#btnSource");a.find('button[class*="btn-valid"]').removeClass("btn-valid").addClass("btn-invalid"),t.forEach(function(e){$("#s"+e).addClass("btn-valid")})}}var method=0,methodRange=[0,1],period=1,periodRange=[10,30,60,90,120],source=[0],sourceRange=["*","guba","(report OR announce)","news"],sourceName=["投资者总体","散户群体","从业人群","新闻媒体"],theme=[],jump=!1,loginfo,lineChart=echarts.init(document.getElementById("line-chart")),histogram=[],leftWidth=0,rightWidth=0,leftRatio=55,rightRatio=45,chartIndex=["文本相关度","价格相关度","流通市值","机构持股比例","股价","5日涨幅"],chartColor=["rgba(199,194,93, .75)","rgba(75,188,208, .75)"],HEATURL="/cross?id=0&",STOCKURL="/cross?id=1&",URL_ADDFRESHWORD="/crosspost?id=10",URL_COLLECT="/crosspost?id=13",URL_UNCOLLECT="/crosspost?id=14",URL_ALLCONCEPTS="/cross?id=23";$(document).ready(function(){$.ajax({url:URL_ALLCONCEPTS,type:"GET",async:!1,dataType:"json",success:function(e){var t=JSON.parse(e);if(t=JSON.parse(t),t&&t.length){var a=Math.floor(Math.random()*(t.length>10?10:t.length));theme[0]=t[a],_renderDatalist(t)}},error:function(e){console.log(e)}}),window.user&&(loginfo=window.user.replace(/&quot;/g,'"'),loginfo=JSON.parse(loginfo),delete window.user),$("#fresh-word").on("input propertychange",function(e){var t=$(this)[0];$(t).val()?$("#btnFresh").attr("disabled",!1):$("#btnFresh").attr("disabled",!0)}),$("#fresh-word").keydown(function(e){var t=e.keyCode;13==t&&(e.preventDefault(),onAddFreshWord())}),$("#datepicker").datetimepicker();var e=$("#datepicker").data("datetimepicker");if(e.setLocalDate(new Date),$(window).on("load resize",function(){lineChart.resize()}),window.concept){var t=window.concept;delete window.concept,jump=!0,theme[0]=t,_setCondition(theme),_renderCharts()}if(window.themes&&window.sources){theme=unescape(decodeURIComponent(window.themes)).split(";"),source=[];var a=unescape(decodeURIComponent(window.sources)).split(";");a.forEach(function(e){source.push(sourceName.indexOf(e))}),delete window.themes,delete window.sources,jump=!0,source.length>1&&(method=1),_setCondition(theme,source),_renderCharts()}jump||(jump=!0,_setCondition(theme),_renderCharts()),$("#form-theme").submit(function(e){e.preventDefault();var t=$("#date-input").val();return t?source.length?theme.length?(_hideErr(),void _renderCharts()):void _showErr("主题信息不能为空!"):void _showErr("关注人群不能为空!"):void _showErr("回溯日期不能为空!")})});
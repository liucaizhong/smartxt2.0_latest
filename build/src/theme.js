"use strict";function _renderDatalist(e){var t=$("#allConcepts");e.forEach(function(e){var a=document.createElement("OPTION");$(a).val(e),t.append(a)})}function _renderCharts(e,t){if($("html, body").animate({scrollTop:$("#charts").offset().top-100},800),$("div.focus-loading").show(),1!=method){var a="sn"+source[0],o=$("#"+a);o.hasClass("active")||($("#sourceNavs").find('a.nav-link[class*="active"]').removeClass("active"),o.addClass("active")),$("#sourceNavs").show()}else $("#sourceNavs").hide();$(".theme-inputbar").show(),e||(e=_genUrl(HEATURL)),t||(t=_genUrl(STOCKURL,!0)),$.ajax({url:encodeURI(e),type:"GET",async:!0,cache:!1,success:function(e){var t=JSON.parse(e);t&&t.length&&(_renderLineChart(t),$("div.focus-loading").hide())},error:function(e){console.log(e)}}),$.ajax({url:encodeURI(t),type:"GET",async:!0,cache:!1,success:function(e){var t=JSON.parse(e);t&&t.length&&_renderHistogram(t)},error:function(e){console.log(e)}})}function _genUrl(e,t){var e=e+"userId=",a="concepts=",o="sources=",s="date=",n="period=";return loginfo&&(e+=loginfo.username),2!=method?theme.forEach(function(e){a+=e.trim()+";"}):theme.forEach(function(e){a+=e.trim()+","}),a=a.substr(0,a.length-1),source.forEach(function(e){o+=e+";"}),o=o.substr(0,o.length-1),e+="&"+a+"&"+o,t&&(s+=$("#date-input").val().replace(/\//g,""),n+=periodRange[period],e+="&"+s+"&"+n),e}function onTriggerSlide(e){if(loginfo){var t=$(e),a=t.find("i.fa-angle-double-down")[0],o=t.find("i.fa-angle-double-up")[0];a&&$(a).removeClass("fa-angle-double-down").addClass("fa-angle-double-up"),o&&$(o).removeClass("fa-angle-double-up").addClass("fa-angle-double-down"),$(".theme-conditions .container").slideToggle(1e3)}else $.StandardPost("/login/theme",{link:"/theme",keyword:theme[0]})}function onMethod(e){var t=$(e),a=t.attr("id")[1];if(method!=+a){method=+a,_setDefault();var o=t.siblings('button[class*="btn-valid"]');Array.prototype.forEach.call(o,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")}),t.removeClass("btn-invalid").addClass("btn-valid")}}function _setDefault(){2==method?($("#btnAddTheme").removeClass("fa-plus-circle").addClass("fa-link"),$("#theme-input").attr("placeholder","请逐次输入要搜索的关键词,例如“煤炭”")):($("#btnAddTheme").removeClass("fa-link").addClass("fa-plus-circle"),$("#theme-input").attr("placeholder","输入关键字用于描述要查询的主题信息,例如 “钢铁”")),1==method?(theme=theme.slice(0,1),$("#theme-tags").find('div:not([data-txt="'+theme[0].trim()+'"])').remove()):(source=source.slice(0,1),$("#s"+source[0]).siblings('[class*="btn-valid"]').removeClass("btn-valid").addClass("btn-invalid"))}function onPeriod(e){var t=$(e),a=t.attr("id")[1];if(period!=a){period=a;var o=t.siblings('button[class*="btn-valid"]');Array.prototype.forEach.call(o,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")}),t.removeClass("btn-invalid").addClass("btn-valid")}}function onSource(e){if(1!=method){var t=$(e),a=+t.attr("id")[1];if(source[0]!=a){source[0]=a;var o=t.siblings('button[class*="btn-valid"]');Array.prototype.forEach.call(o,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")}),t.removeClass("btn-invalid").addClass("btn-valid")}}else{var t=$(e),a=+t.attr("id")[1],s=source.indexOf(a);-1==s?(source.push(a),t.removeClass("btn-invalid").addClass("btn-valid")):(source.splice(s,1),t.removeClass("btn-valid").addClass("btn-invalid"))}}function _showErr(e){$("div#error-msg>strong").text(e),$("div#error-msg").show(500)}function _hideErr(){$("div#error-msg").hide(500)}function addTheme(e){var t=$("input#theme-input"),a=t.val();if(1==method&&theme.length>=1)return t.val(""),void _showErr("只能输入1个关键字");if(a){t.val(""),theme.push(a);var o=$('<div class="theme-tag alert alert-success col-xs-3 col-lg-2"></div>')[0],s=$(o);s.attr("data-txt",a),s.hover(function(e){$(this).find(".submit-word").show()},function(e){$(this).find(".submit-word").hide()});var n=$('<div class="submit-word" onclick="onAddFreshWord(this)">新词提交</div>')[0];$(n).append($('<i class="fa fa-caret-down" aria-hidden="true"></i>')),s.append(n);var i=$('<span class="theme-txt"></span>')[0];$(i).text(a),s.append(i);var r=$('<button type="button" class="close" aria-label="Close" onclick="delThemeTag(this)"><span aria-hidden="true">&times;</span></button>')[0];s.append(r),$("#theme-tags").append(o)}}function delThemeTag(e){var t=$(e),a=t.parent(),o=t.siblings("span")[0],s=theme.indexOf($(o).text());theme.splice(s,1),$(a).remove(),theme.length||_hideErr()}function delAlert(e){var t=$(e);t.parent().hide(500)}function _renderLineChart(e){lineChart=echarts.init(document.getElementById("line-chart"));var t=e[0].flag;if(t==-1)return!1;if(0==t){var a=$("i[class*=icon-collect]");a.hasClass("icon-collected")&&a.removeClass("icon-collected")}else if(1==t){var a=$("i[class*=icon-collect]");a.hasClass("icon-collected")||a.addClass("icon-collected")}var o=e.splice(1),s=[],n=[],i=[];Array.isArray(o)&&o.forEach(function(e){var t={name:e.concept+" H",type:"line",yAxisIndex:0,itemStyle:{normal:{areaStyle:{type:"default",color:"rgba(239,243,246,.6)"},color:"rgb(50,70,90)"}},symbol:"none"},a={name:e.concept+" I",type:"line",yAxisIndex:1,itemStyle:{normal:{areaStyle:{type:"default",color:"rgba(250,225,222,.6)"},color:"rgb(235,85,30)"}},symbol:"none"},o=[],r=[];1==method?(s.push({name:sourceName[+e.source]+" H",icon:"line"}),s.push({name:sourceName[+e.source]+" I",icon:"line"}),t.name=sourceName[+e.source]+" H",a.name=sourceName[+e.source]+" I"):(s.push({name:e.concept+" H",icon:"line"}),s.push({name:e.concept+" I",icon:"line"})),e.heat.forEach(function(e){o.push(e.heat),r.push(e.index),n.push(e.date)}),t.data=o,i.push(t),a.data=r,i.push(a)});var r="";r=1!=method?sourceName[source[0]]:theme[0],lineChart.setOption({baseOption:{title:{},tooltip:{trigger:"axis"},dataZoom:[{handleColor:"rgb(75,188,208)",fillerColor:"rgb(75,188,208)",borderWidth:0,show:!0,realtime:!0,start:75.5,end:100,height:15}],legend:{data:s},toolbox:{feature:{saveAsImage:{}}},xAxis:{type:"category",data:n,axisLine:{show:!0,lineStyle:{type:"solid",width:1,color:"rgb(75,188,208)"}},axisTick:!1,axisLabel:{textStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},boundaryGap:!1},yAxis:[{name:"关注度(H)",type:"value",splitNumber:10,scale:!0,axisLine:{show:!0,lineStyle:{type:"solid",width:1,color:"rgb(75,188,208)"}},axisLabel:{textStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},splitLine:{show:!0,lineStyle:{type:"dashed",width:1}},nameTextStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},{name:"指数(I)",type:"value",splitNumber:10,scale:!0,axisLine:{show:!0,lineStyle:{type:"solid",width:1,color:"rgb(75,188,208)"}},axisLabel:{textStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}},splitLine:{show:!1,lineStyle:{type:"dashed",width:1}},nameTextStyle:{color:"black",fontFamily:"微软雅黑",fontSize:12}}],series:i}})}function _renderHistogram(e){var t=e[0].flag;if(t==-1)return!1;var a=e.splice(1),o=[],s=[],n=$($("#tab-list")[0]),i=$($("#tab-content")[0]);n.empty(),i.empty(),histogram=[],Array.isArray(a)&&a.forEach(function(e){1==method?o.push(sourceName[+e.source]):o.push(e.concept);var t=[],a=[],n=[],i=[],r=[],l=[],d=[];if(e.stocks&&e.stocks.length){var c=e.stocks;c.forEach(function(e){t.push(e.name+"("+e.code+")"),a.push(e.txtCor),n.push(e.priceCor),i.push(e.MV),r.push(e.HOLD),l.push(e.CP),d.push(e.RT)}),s.push({category:t,data:[a,n,i,r,l,d]})}else s.push({})});for(var r=0,l=o.length;r<l;++r){var d="c"+r,c=$('<li class="nav-item"></li>'),h=$('<a class="nav-link" data-toggle="tab"role="tab"></a>');$(h).attr("href","#"+d).text(o[r]),r||$(h).addClass("active"),$(c).append(h),n.append(c);var u=$('<div class="tab-pane" role="tabpanel"></div>');$(u).attr("id",d),r||$(u).addClass("active"),i.append(u);var p=jQuery.isEmptyObject(s[r]);if(p)i.text("不存在股票相关指数！").addClass("theme-error-msg");else{i.hasClass("theme-error-msg")&&i.removeClass("theme-error-msg");for(var m=chartIndex.length,f=0;f<m;++f)f%2?(_renderRightHistogram(s[r].category,s[r].data[f],chartIndex[f],chartColor[f%2],d),echarts.connect([histogram[f-1+m*r],histogram[f+m*r]])):_renderLeftHistogram(s[r].category,s[r].data[f],chartIndex[f],chartColor[f%2],d)}$("footer").hasClass("none")&&$("footer").show()}}function _renderLeftHistogram(e,t,a,o,s){if(t){var n=$('<div class="rel-chart-l"></div>'),i=$("#"+s);leftWidth||(leftWidth=$(i).width()*leftRatio/100),$(n).css("width",leftWidth+"px"),$(i).append(n);var r=echarts.init(n[0]);histogram.push(r),r.setOption({tooltip:{trigger:"axis",axisPointer:{type:"shadow"},position:function(e,t,a){return $(a).width("200"),[e[0],e[1]+18]}},grid:{containLabel:!0},color:[o],legend:{data:[a],x:"right",textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},xAxis:{type:"value",position:"top",axisLine:{show:!1},splitNumber:10,splitLine:{show:!0,lineStyle:{type:"dashed",width:1}},axisLabel:{textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},axisTick:!1},yAxis:{type:"category",data:e,position:"left",inverse:!0,axisTick:!1,axisLine:{show:!1},splitLine:{show:!1}},series:[{name:a,type:"bar",barMaxWidth:"30px",label:{normal:{show:!1,position:"insideRight"}},data:t}]})}}function _renderRightHistogram(e,t,a,o,s){if(t){var n=$('<div class="rel-chart-r"></div>'),i=$("#"+s);rightWidth||(rightWidth=$(i).width()*rightRatio/100),$(n).css("width",rightWidth+"px"),$(i).append(n);var r=echarts.init(n[0]);histogram.push(r),r.setOption({tooltip:{trigger:"axis",axisPointer:{type:"shadow"},position:function(e,t,a){return $(a).width("200"),[e[0],e[1]+18]}},grid:{containLabel:!0},legend:{data:[a],x:"left",textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},xAxis:{type:"value",position:"top",axisLine:{show:!1},splitNumber:10,splitLine:{show:!0,lineStyle:{type:"dashed",width:1}},axisLabel:{textStyle:{fontFamily:"微软雅黑",fontSize:12,color:"black"}},axisTick:!1},yAxis:{type:"category",data:e,position:"left",inverse:!0,axisLabel:{show:!1,inside:!0},axisTick:!1,axisLine:{show:!1},splitLine:{show:!1}},color:[o],series:[{name:a,type:"bar",barMaxWidth:"30px",label:{normal:{show:!1,position:"insideRight"}},data:t}]})}}function onEnterTheme(e){e.stopPropagation(),13==e.keyCode&&$("#theme-input").val()&&(e.preventDefault(),addTheme())}function onHelp(e){loginfo||$.StandardPost("/login/theme",{link:"/theme",keyword:theme[0]})}function onStar(e){if(!loginfo)return void $.StandardPost("/login/theme",{link:"/theme",keyword:theme[0]});var t=$(e).find("i");if(t.hasClass("icon-collected")){var a=URL_UNCOLLECT,o="取消收藏",s="";s+=theme.join(";")+"@",s+=source.join(";");var n={userId:loginfo.username,links:s}}else var a=URL_COLLECT,o="已收藏",n={userId:loginfo.username,concept:theme.join(";"),source:source.join(";")};$.ajax({url:a,method:"POST",data:n,dataType:"json",success:function(e){var a=JSON.parse(e);a.flag||a[0].status?(t.toggleClass("icon-collected"),_showFadeMsg(o,$(".suspending-toolbar").offset().left-100,$(".suspending-toolbar").offset().top+100)):_showFadeMsg(a.msg)},error:function(e){console.log(e)}})}function onsourceNav(e){var t=$(e);$("#sourceNavs").find('a.nav-link[class*="active"]').removeClass("active"),t.addClass("active");var a=t.attr("id");source[0]=a.substr(a.length-1,1),_renderCharts()}function _showFadeMsg(e,t,a){$("#fade-msg").text(e),t||(t="35%"),a||(a="45%"),$("#fade-alert").css({left:t,top:a}).fadeIn(function(){setTimeout(function(){$("#fade-alert").fadeOut()},1e3)})}function onAddFreshWord(e){var t=$(e).parent().find(".theme-txt").text();$.ajax({url:URL_ADDFRESHWORD,method:"POST",data:{userId:loginfo.username,concept:t},dataType:"json",success:function(e){var a=JSON.parse(e);_showFadeMsg(a.flag?"新词："+t+" 提交成功":a.msg)},error:function(e){console.log(e)}})}function _setCondition(e,t,a){if(e&&($("#btnMethod").find('button[class*="btn-valid"]').removeClass("btn-valid").addClass("btn-invalid"),$("#m"+e).removeClass("btn-invalid").addClass("btn-valid")),t&&0!=t.length&&t.forEach(function(e){var t=$('<div class="theme-tag alert alert-success col-xs-3 col-lg-2"></div>')[0],a=$(t);a.attr("data-txt",e),a.hover(function(e){$(this).find(".submit-word").show()},function(e){$(this).find(".submit-word").hide()});var o=$('<div class="submit-word" onclick="onAddFreshWord(this)">新词提交</div>')[0];$(o).append($('<i class="fa fa-caret-down" aria-hidden="true"></i>')),a.append(o);var s=$('<span class="theme-txt"></span>')[0];$(s).text(e),a.append(s);var n=$('<button type="button" class="close" aria-label="Close" onclick="delThemeTag(this)"><span aria-hidden="true">&times;</span></button>')[0];a.append(n),$("#theme-tags").append(t)}),a&&0!=a.length){var o=$("#btnSource");o.find('button[class*="btn-valid"]').removeClass("btn-valid").addClass("btn-invalid"),a.forEach(function(e){$("#s"+e).removeClass("btn-invalid").addClass("btn-valid")})}}function onSearchWord(){$("#theme-tags").empty(),theme=[$("#fresh-word").val()],$("#fresh-word").val(""),$("#btnFresh").attr("disabled",!0),_setCondition(method,theme),_renderCharts()}var method=0,methodRange=[0,1],period=1,periodRange=[10,30,60,90,120],source=[0],sourceRange=["*","guba","(report OR announce)","news"],sourceName=["投资者总体","散户群体","从业人群","新闻媒体"],theme=[],jump=!1,loginfo,lineChart=echarts.init(document.getElementById("line-chart")),histogram=[],leftWidth=0,rightWidth=0,leftRatio=55,rightRatio=45,chartIndex=["文本相关度","价格相关度","流通市值","机构持股比例","股价","5日涨幅"],chartColor=["rgba(199,194,93, .75)","rgba(75,188,208, .75)"],HEATURL="/cross?id=0&",STOCKURL="/cross?id=1&",URL_ADDFRESHWORD="/crosspost?id=10",URL_COLLECT="/crosspost?id=13",URL_UNCOLLECT="/crosspost?id=14",URL_ALLCONCEPTS="/cross?id=23";$(document).ready(function(){window.user&&(loginfo=window.user.replace(/&quot;/g,'"'),loginfo=JSON.parse(loginfo),delete window.user),$("#fresh-word").on("input propertychange",function(e){var t=$(this)[0];$(t).val()?$("#btnFresh").attr("disabled",!1):$("#btnFresh").attr("disabled",!0)}),$("#fresh-word").keydown(function(e){var t=e.keyCode;13==t&&(e.preventDefault(),onSearchWord())}),$("#datepicker").datetimepicker();var e=$("#datepicker").data("datetimepicker");if(e.setLocalDate(new Date),$(window).on("load resize",function(){lineChart.resize();var e=$(window).width();e<1520&&e>795?$(".suspending-toolbar").css({right:"8%"}):e<795?$(".suspending-toolbar").css({right:"5%"}):$(".suspending-toolbar").css({right:"15%"})}),$(window).resize(),window.concept){var t=window.concept;delete window.concept,jump=!0,theme[0]=t,_setCondition(method,theme),_renderCharts()}if(window.word){var a=unescape(decodeURIComponent(window.word));delete window.word,jump=!0,theme[0]=a,_setCondition(method,theme),_renderCharts()}if(window.themes&&window.sources){jump=!0,source=[];var o=unescape(decodeURIComponent(window.sources)).split(";");o.forEach(function(e){source.push(sourceName.indexOf(e))});var s=unescape(decodeURIComponent(window.themes));s.indexOf(";")!=-1?(theme=s.split(";"),method=2):(theme=s.split(","),method=source.length>1?1:0),delete window.themes,delete window.sources,_setCondition(method,theme,source),_renderCharts()}$.ajax({url:URL_ALLCONCEPTS,type:"GET",async:!0,cache:!1,success:function(e){var t=JSON.parse(e);if(t&&t.length&&(_renderDatalist(t),!jump)){var a=Math.floor(Math.random()*(t.length>10?10:t.length));theme[0]=t[a],_setCondition(method,theme),_renderCharts()}},error:function(e){console.log(e)}}),$("#form-theme").submit(function(e){e.preventDefault();var t=$("#date-input").val();return t?source.length?theme.length?(_hideErr(),void _renderCharts()):void _showErr("主题信息不能为空!"):void _showErr("关注人群不能为空!"):void _showErr("回溯日期不能为空!")})});
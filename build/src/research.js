"use strict";function clearSearch(e){$("#stockInput").val(""),$(e).hide(),_hideStockList(),_renderData(0)}function customOpStock(e){if(e){var t=$(e),r=t.find('span[class*="item-1"]').text(),a=t.find('span[class*="item-2"]').text();$("#stockInput").val(""),$("#search-clear").hide(),console.log(r,a),console.log("selfChoice",selfChoice);var n=URL_SURVEY+"userId="+loginfo.username+"&period=10&keyword="+r+"&selfStocksOnly="+(selfChoice?1:0);$.ajax({url:n,method:"GET",dataType:"json",success:function(e){var t=JSON.parse(e);t=JSON.parse(t),_renderSearchResults(t)},error:function(e){console.log(e)}})}}function _renderData(e){resAll[e]&&resAll[e].length?(_renderTheme(resIndus[e]),_renderMap(searchMap,resProv[e]),_renderResults(resAll[e])):$.ajax({url:URL_SURVEY_FILE[e],method:"GET",dataType:"json",success:function(t){var r=JSON.parse(t);r=JSON.parse(r),resBuy[e]=r.all[0].codes,resSell[e]=r.all[1].codes,resAll[e]=resBuy[e].concat(resSell[e]),resIndus[e]=r.industry,resProv[e]=r.province,_renderTheme(resIndus[e]),_renderMap(searchMap,resProv[e]),_renderResults(resAll[e])},error:function(e){console.log(e)}})}function onPeriod(e){var t=$(e);t.hasClass("btn-invalid")&&(_clearPeriod(),_clearSource(),$("#s0").removeClass("btn-invalid").addClass("btn-valid"),_clearTheme(),t.removeClass("btn-invalid").addClass("btn-valid"),curPeriod=t.attr("id").substring(1),_renderData(curPeriod))}function _clearPeriod(){var e=$("#btnPeriod").children("button.btn-valid");Array.prototype.forEach.call(e,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")})}function onSource(e){var t=$(e);if(t.hasClass("btn-invalid")){_clearSource(),_clearTheme(),_clearMap(searchMap),t.removeClass("btn-invalid").addClass("btn-valid");var r=t.attr("id")[1];switch(r){case"0":_renderResults(resAll[curPeriod]);break;case"1":_renderResults(resBuy[curPeriod]);break;case"2":_renderResults(resSell[curPeriod])}}}function _clearSource(){var e=$("#btnSource").children("button.btn-valid");Array.prototype.forEach.call(e,function(e){$(e).removeClass("btn-valid").addClass("btn-invalid")})}function _renderTheme(e){var t=$("#btnTheme");(t.children()||t.children().length)&&t.empty();var r=document.createDocumentFragment();e.forEach(function(e,t){var a=document.createElement("SPAN");$(a).attr("id","t"+t).addClass("research-tag-invalid").text(e.indus[0]),$(r).append(a)}),t.append(r)}function onTheme(e,t){t.stopPropagation(),t.preventDefault();var r=$(t.target),a=t.target.tagName;if("SPAN"===a&&r.hasClass("research-tag-invalid")){_clearTheme(),_clearSource(),_clearMap(searchMap),r.removeClass("research-tag-invalid").addClass("research-tag-valid");var n=resIndus[curPeriod][r.attr("id")[1]];console.log("themeObj",n),_renderResults(n)}}function _clearTheme(){var e=$("#btnTheme").children("span.research-tag-valid");Array.prototype.forEach.call(e,function(e){$(e).removeClass("research-tag-valid").addClass("research-tag-invalid")})}function _renderResults(e){var t=$("#result-list");if((t.children()||t.children().length)&&t.empty(),!e)return void t.append($("<p>没有相关的调研记录</p>"));var r=[];if(Array.isArray(e))r=e;else{var a=e.code;a.forEach(function(e){resAll[curPeriod].forEach(function(t){t.code[0]===e&&r.push(t)})})}r.forEach(function(e,r){e.dates.forEach(function(r,a){var n=document.createElement("DIV"),s=$(n);s.addClass("col-xs-6").addClass("col-lg-3");var o=document.createElement("DIV"),l=$(o);l.addClass("research-card");var d=document.createElement("DIV");$(d).addClass("card-header");var c=document.createElement("DIV");$(c).addClass("research-left-header");var i=document.createElement("H6");$(i).text(r.affs.length),$(c).append(i),$(d).append(c);var u=document.createElement("DIV");$(u).addClass("research-right-header");var p=document.createElement("H5");$(p).addClass("research-card-title").text(r.date[0]),$(u).append(p);var m=document.createElement("P");$(m).addClass("research-card-text").text(e.name[0]+"("+e.code[0]+")"),$(u).append(m),$(d).append(u),l.append(d);var h=document.createElement("DIV");$(h).addClass("card-content");var f=document.createElement("DIV"),v=$(f);v.addClass("card-item");var I=document.createElement("SPAN");$(I).addClass("item-title").text("调查机构/研究员:"),v.append(I),r.affs.forEach(function(e){var t=document.createElement("SPAN"),r=$(t);r.addClass("item-content").attr("data-toggle","popover"),r.hover(function(e){var t=$(e.target);t.popover("show");var r=t.attr("aria-describedby"),a=$("#"+r)[0],n=$(a).find("div.popover-content")[0],s=document.createElement("PRE");$(s).text($(n).text()),$(n).text("").append(s)},function(e){var t=$(e.target),r=t.attr("aria-describedby");if(r){var a=$("#"+r)[0],n=$(a);$resultItem=t;var s=e.pageX,o=e.pageY,l=$resultItem.width(),d=$resultItem.height(),c=$resultItem.offset().left,i=$resultItem.offset().top;s>c&&s<c+l+10&&(o>i+d||o<i)&&($resultItem.removeClass("hover-item-content"),$resultItem.popover("hide"),$resultItem=null),n.hover(function(e){$resultItem&&($resultItem.hasClass("hover-item-content")||$resultItem.addClass("hover-item-content"))},function(e){var t=e.pageX,r=e.pageY;if($resultItem){var a=$resultItem.width(),n=$resultItem.height(),s=$resultItem.offset().left,o=$resultItem.offset().top;t>s&&r>o&&t<s+a+10&&r<o+n||($resultItem.removeClass("hover-item-content"),$resultItem.popover("hide"),$resultItem=null)}})}});var a=e.aff[0]+"/";if(e.persons.person.forEach(function(e){a+=e+" "}),r.text(a),e.persons.report){r.append($('<i class="fa fa-bookmark" aria-hidden="true" style="color:#F6310D;"></i>')),r.attr("title","相关研报:");var n="";e.persons.report.forEach(function(e){n+=e.reportDate+":\n"+_newLine(e.reportName)+"\n"}),r.attr("data-content",n)}v.append(t)}),$(h).append(f),l.append(h),s.append(o),t.append(n)})}),$("html, body").animate({scrollTop:$("section#research-list").offset().top-100},800)}function _renderMap(e,t){var r=0,a=t.map(function(e){return r+=parseInt(e.count[0]),{name:e.prov[0],value:e.count[0],more:{code:e.code}}});e.showLoading(),e.setOption({baseOption:{tooltip:{trigger:"item"},visualMap:{min:0,max:r,splitNumber:20,color:["#d94e5d","#50a3ba","#eac736"],textStyle:{color:"#fff"},show:!1},series:[{name:"报告数",type:"map",map:"china",label:{normal:{show:!0},emphasis:{show:!0}},itemStyle:{emphasis:{borderColor:"#9900ff"}},data:a}]},media:[]}),e.on("click",function(t){console.log(t);var r=t.dataIndex;r!=mapIndex&&(_clearSource(),_clearTheme(),_clearMap(e),mapIndex=r,e.dispatchAction({type:"highlight",seriesIndex:0,dataIndex:mapIndex}),t.data?_renderResults(t.data.more):_renderResults())}),e.hideLoading()}function _clearMap(e){mapIndex!=-1&&(e.dispatchAction({type:"downplay",seriesIndex:0,dataIndex:mapIndex}),mapIndex=-1)}function _renderSearchResults(e){var t=$("#result-list");return(t.children()||t.children().length)&&t.empty(),e&&e.length?(e.forEach(function(e){var r=document.createElement("DIV"),a=$(r);a.addClass("col-xs-6").addClass("col-lg-3");var n=document.createElement("DIV"),s=$(n);s.addClass("research-card");var o=document.createElement("DIV");$(o).addClass("card-header");var l=document.createElement("DIV");$(l).addClass("research-left-header");var d=document.createElement("H6");$(d).text(e.reportList.length),$(l).append(d),$(o).append(l);var c=document.createElement("DIV");$(c).addClass("research-right-header");var i=document.createElement("H5");$(i).addClass("research-card-title").text(e.dytime),$(c).append(i);var u=document.createElement("P");$(u).addClass("research-card-text").text(e.name+"("+e.code+")"),$(c).append(u),$(o).append(c),s.append(o);var p=document.createElement("DIV");$(p).addClass("card-content");var m=document.createElement("DIV"),h=$(m);h.addClass("card-item");var f=document.createElement("SPAN");$(f).addClass("item-title").text("调查机构/研究员:"),h.append(f),e.reportList.forEach(function(e){var t=document.createElement("SPAN"),r=$(t);r.addClass("item-content").attr("data-toggle","popover"),r.hover(function(e){var t=$(e.target);t.popover("show");var r=t.attr("aria-describedby"),a=$("#"+r)[0],n=$(a).find("div.popover-content")[0],s=document.createElement("PRE");$(s).text($(n).text()),$(n).text("").append(s)},function(e){var t=$(e.target),r=t.attr("aria-describedby");if(r){var a=$("#"+r)[0],n=$(a);$resultItem=t;var s=e.pageX,o=e.pageY,l=$resultItem.width(),d=$resultItem.height(),c=$resultItem.offset().left,i=$resultItem.offset().top;s>c&&s<c+l+10&&(o>i+d||o<i)&&($resultItem.removeClass("hover-item-content"),$resultItem.popover("hide"),$resultItem=null),n.hover(function(e){$resultItem&&($resultItem.hasClass("hover-item-content")||$resultItem.addClass("hover-item-content"))},function(e){var t=e.pageX,r=e.pageY;if($resultItem){var a=$resultItem.width(),n=$resultItem.height(),s=$resultItem.offset().left,o=$resultItem.offset().top;t>s&&r>o&&t<s+a+10&&r<o+n||($resultItem.removeClass("hover-item-content"),$resultItem.popover("hide"),$resultItem=null)}})}});var a=e.aff+"/"+e.analyst;if(r.text(a),!jQuery.isEmptyObject(e.reports[0])){r.append($('<i class="fa fa-bookmark" aria-hidden="true" style="color:#F6310D;"></i>')),r.attr("title","相关研报:");var n="";e.reports.forEach(function(e){n+=e.pubDate+":\n"+_newLine(e.title)+"\n"}),r.attr("data-content",n)}h.append(t)}),$(p).append(m),s.append(p),a.append(n),t.append(r)}),void $("html, body").animate({scrollTop:$("section#research-list").offset().top-100},800)):void t.append($("<p>没有相关的调研记录</p>"))}function _newLine(e){for(var t="",r=0,a=0,n=35,s=-1,o=0;o<e.length;o++)s=e.charCodeAt(o),r+=s>=0&&s<=128?1:2;for(var o=0;o<r;o++){var l=e.charAt(o);a++,escape(l).length>4&&a++,t=t.concat(l),a>=n&&(t=t.concat("\n"),a=0)}return t}var searchMap=echarts.init(document.getElementById("searchMap"),"macarons"),resBuy={},resSell={},resAll={},resIndus={},resProv={},mapIndex=-1,$resultItem=null,URL_SURVEY="/cross?id=21&",URL_SURVEY_FILE=[],loginfo,selfChoice=!1,curPeriod=0,selfStock;$(document).ready(function(){window.user&&(loginfo=window.user.replace(/&quot;/g,'"'),loginfo=JSON.parse(loginfo),delete window.user,URL_SURVEY_FILE[0]=URL_SURVEY+"userId="+loginfo.username+"&period=10&keyword=&selfStocksOnly=0",URL_SURVEY_FILE[1]=URL_SURVEY+"userId="+loginfo.username+"&period=20&keyword=&selfStocksOnly=0",URL_SURVEY_FILE[2]=URL_SURVEY+"userId="+loginfo.username+"&period=30&keyword=&selfStocksOnly=0",_renderData(0)),$(".auto-refresh > input[name=self]").change(function(e){selfChoice=!selfChoice;var t=URL_SURVEY+"userId="+loginfo.username+"&period=10&keyword=&selfStocksOnly=1";selfChoice&&$.ajax({url:t,method:"GET",dataType:"json",success:function(e){var t=JSON.parse(e);t=JSON.parse(t),_renderSearchResults(t)},error:function(e){console.log(e)}})}),$("#stockInput").on("input propertychange",function(e){var t=$(this).val();t&&$("#search-clear").show()}),$(window).on("resize",function(){searchMap.resize()}),$("body").popover({placement:"right",trigger:"manual"})});
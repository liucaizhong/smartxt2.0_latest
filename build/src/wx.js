"use strict";function onCategory(e){e.stopPropagation();var n=e.target;if("LABEL"===n.tagName){var t=$(n);if(+t.attr("data-id"))if(t.hasClass("active")){t.removeClass("active");var a=t.attr("data-id"),s=activeCategory.indexOf(a);activeCategory.splice(s,1),activeCategory.length||(activeCategory=["0"],t.parent().find("[data-id=0]").addClass("active"))}else{var o=t.parent().find("[class*=active]").length,r=t.siblings().length-1;if(o==r)t.parent().find("[class*=active]").removeClass("active"),t.parent().find("[data-id=0]").addClass("active"),activeCategory=["0"];else{t.addClass("active"),t.parent().find("[data-id=0]").removeClass("active");var s=activeCategory.indexOf("0");s!=-1&&activeCategory.splice(s,1),activeCategory.push(t.attr("data-id"))}}else t.parent().find("[class*=active]").removeClass("active"),t.hasClass("active")||(t.addClass("active"),activeCategory.push(t.attr("data-id")),activeCategory=["0"]);_renderMoreNews()}console.log("activeCategory",activeCategory)}function _renderMoreNews(e){console.log("Now the time is",new Date),console.log("lastId",lastId),e||(lastId=-1,$(".news-content>ol").empty());var n=URL_CHATS+"userId="+loginfo.username+"&lastId="+lastId;n+=keyword?"&keyword="+keyword:"&keyword=",n+=selfChoice?"&selfStocksOnly=1":"&selfStocksOnly=0","0"==activeCategory[0]?n+="&types=":(n+="&types=",activeCategory.forEach(function(e){n+="'"+categoryRange[+e]+"',"}),n=n.substr(0,n.length-1)),$.ajax({url:n,type:"GET",async:!0,dataType:"json",success:function(e){var n=JSON.parse(e);n=JSON.parse(n),n&&n.length&&($("#error-msg").hide(),0!=n[0].flag?($("#error-msg strong").text(n[0].msg),$("#error-msg").show(),$(".more-button").hide()):1==n.length?($("footer").show(),$(".more-button").hide()):(n.slice(1,n.length).forEach(function(e){_renderNewsContent(e)}),keyword&&$(".news-content").highlight(keyword),$(".more-button").show(),$("footer").hide()))},error:function(e){console.log(e)}})}function _renderNewsContent(e){var n=$(".news-content>ol"),t=lastId!=-1,a=!1,s=new Date(e.pubTime),o=s.getMonth()+1,r=s.getDate();if(t){var i=$("#"+lastId),d=i.parent(),l=+d.parent().find("header>.date em").text(),c=+d.parent().find("header>.date b").text();if(l!=o||c!=r)a=!0;else{var p=$('<li class="bottom-line">\n                            <div>\n                                <h2 class="title"></h2>\n                                <div>\n                                    <p>\n                                        <span class="short"></span>\n                                        <span class="long none"></span>\n                                        <a class="expand-btn none" href="" onclick="onExpandContent(this,event)">显示全部</a>\n                                    </p>\n                                </div>\n                                <div class="news-footer">\n                                    <span class="tag-date"></span>\n                                    <span>来源：</span>\n                                    <span id="tag-source" class="tag-type"></span>\n                                    <span>相关股票：</span>\n                                    <span id="tag-stock" class="tag-type"></span>\n                                    <button class="collapse-btn none" onclick="onCollapseContent(this)"><i class="fa fa-hand-o-up" aria-hidden="true" style="font-size: 16px;"></i>&nbsp;收起</button>\n                                </div>\n                            </div>\n                        </li>');$(p).attr("id",e.increaseId),$(p).find("h2").text(e.author),e.txt&&(p=_cutStr(e.txt,MAX_ABS,p)),$(p).find("span.tag-date").text(e.pubTime.split(".")[0]),$(p).find("span#tag-source").text(e.aff),$(p).find("span#tag-stock").text(e.code),d.append(p)}}else a=!0;if(a){var p=$('<li class="sameday-news">\n                    <header>\n                        <div class="date">\n                            <span><em></em>月</span>\n                            <b></b>\n                        </div>\n                    </header>\n                    <ul>\n                        <li class="bottom-line">\n                            <div>\n                                <h2 class="title"></h2>\n                                <div>\n                                    <p>\n                                        <span class="short"></span>\n                                        <span class="long none"></span>\n                                        <a class="expand-btn none" href="" onclick="onExpandContent(this,event)">显示全部</a>\n                                    </p>\n                                </div>\n                                <div class="news-footer">\n                                    <span class="tag-date"></span>\n                                    <span>来源：</span>\n                                    <span id="tag-source" class="tag-type"></span>\n                                    <span>相关股票：</span>\n                                    <span id="tag-stock" class="tag-type"></span>\n                                    <button class="collapse-btn none" onclick="onCollapseContent(this)"><i class="fa fa-hand-o-up" aria-hidden="true" style="font-size: 16px;"></i>&nbsp;收起</button>\n                                </div>\n                            </div>\n                        </li>                   \n                    </ul>\n                </li>');$(p).find(".date em").text(o),$(p).find(".date b").text(r),$(p).find(".bottom-line").attr("id",e.increaseId),$(p).find("h2").text(e.author),e.txt&&(p=_cutStr(e.txt,MAX_ABS,p)),$(p).find("span.tag-date").text(e.pubTime.split(".")[0]),$(p).find("span#tag-source").text(e.aff),$(p).find("span#tag-stock").text(e.code),n.append(p)}lastId=e.increaseId}function _getStrLength(e){for(var n=0,t=e.length,a=-1,s=0;s<t;s++)a=e.charCodeAt(s),n+=a>=0&&a<=128?1:2;return n}function _cutStr(e,n,t){var a=_getStrLength(e),s=0,o="";if(n>=a)return $(t).find("span.short").html(e),t;for(var r=0;r<a;r++){var i=e.charAt(r);if(s++,escape(i).length>4&&s++,o=o.concat(i),s>=n)return $(t).find("span.short").html(o+"......"),$(t).find("span.long").html(e),$(t).find(".expand-btn").removeClass("none"),t}}function delAlert(e){$(e).parent().fadeOut()}function onExpandContent(e,n){n.preventDefault();var t=$(e);t.parent().find(".short").hide(),t.parent().find(".long").show(),t.hide().parent().parent().parent().find(".collapse-btn").show()}function onCollapseContent(e){var n=$(e);n.parent().parent().find(".short").show(),n.parent().parent().find(".long").hide(),n.parent().parent().find(".expand-btn").show(),n.hide()}function clearSearch(e){$("#newsInput").val(""),$(e).hide(),keyword="",_renderMoreNews()}var activeCategory=["0"],categoryRange=["*"],INTERVAL=18e5,loginfo,URL_CHATS="/cross?id=20&",URL_AFFLIST="/cross?id=22&",lastId=-1,keyword="",selfChoice=!1,MAX_ABS=500;$(document).ready(function(){if($.ajax({url:URL_AFFLIST,type:"GET",async:!0,dataType:"json",success:function(e){var n=JSON.parse(e);n=JSON.parse(n),n&&n.length&&n.forEach(function(e){var n=$('<label class="label-category" style="margin-right: 5px;"></label>');$(n).attr("data-id",categoryRange.length+"").text(e),categoryRange.push(e),$("#sources").append(n)})},error:function(e){console.log(e)}}),window.user){loginfo=window.user.replace(/&quot;/g,'"'),loginfo=JSON.parse(loginfo),delete window.user,_renderMoreNews();setInterval(_renderMoreNews,INTERVAL)}$(window).scroll(function(){$(window).scrollTop()+$(window).height()==$(document).height()&&($(".more-button span:nth-child(1)").removeClass("active"),$(".more-button span:nth-child(2)").addClass("active"),_renderMoreNews(!0))}),$("#newsInput").keydown(function(e){13==e.keyCode&&(e.preventDefault(),_renderMoreNews())}),$("#newsInput").on("input propertychange",function(e){var n=$(this).val();n?($("#search-clear").show(),keyword=n):($("#search-clear").hide(),keyword="")}),$(".auto-refresh > input[name=self]").change(function(e){selfChoice=!selfChoice,_renderMoreNews(),console.log("selfChoice",selfChoice)})});